From 51d2e61578737461a212c7917a3e8cb57815caa7 Mon Sep 17 00:00:00 2001
From: michaedw in build chroot <build@ctbu-bld5.cisco.com>
Date: Sat, 28 May 2011 04:02:01 +0000
Subject: [PATCH] fix cross-compile of bind export libs

---
 bind/Makefile         |    3 ++-
 bind/bind-cross.patch |   28 ++++++++++++++++++++++++++++
 configure             |    2 +-
 util/bindvar.sh       |    2 ++
 4 files changed, 33 insertions(+), 2 deletions(-)
 create mode 100644 bind/bind-cross.patch

diff --git a/bind/Makefile b/bind/Makefile
index ce167b6..ae536ea 100644
--- a/bind/Makefile
+++ b/bind/Makefile
@@ -34,6 +34,7 @@ all:
 		echo ${bindsrcdir} already unpacked... ;    \
 	else                                                \
 		gunzip -c bind.tar.gz | tar xf - ;          \
+		patch -p2 < bind-cross.patch ;              \
 	fi
 
 	@if test -z "${GMAKE}"; then                        \
@@ -45,7 +46,7 @@ all:
 # Currently disable the epoll and devpoll options as they don't interact
 # well with the DHCP code.
 	@echo Configuring BIND Export libraries for DHCP.
-	@(cd ${bindsrcdir} && ./configure --disable-kqueue --disable-epoll --disable-devpoll --without-openssl --without-libxml2 --enable-exportlib --enable-threads=no --with-export-includedir=${binddir}/include --with-export-libdir=${binddir}/lib > ${binddir}/configure.log)
+	@(cd ${bindsrcdir} && CFLAGS="-g -Os" ./configure --build ${build_alias} --host ${host_alias} --prefix=/usr --localstatedir=/var --sysconfdir=/etc --mandir=/usr/share/man --infodir=/usr/share/info --with-randomdev=/dev/random --disable-kqueue --disable-epoll --disable-devpoll --without-openssl --without-libxml2 --enable-exportlib --enable-threads=no --with-export-includedir=${binddir}/include --with-export-libdir=${binddir}/lib > ${binddir}/configure.log)
 
 # Build the export libraries
 	@echo Building BIND Export libraries - this takes some time.
diff --git a/bind/bind-cross.patch b/bind/bind-cross.patch
new file mode 100644
index 0000000..4957fff
--- /dev/null
+++ b/bind/bind-cross.patch
@@ -0,0 +1,28 @@
+# --- T2-COPYRIGHT-NOTE-BEGIN ---
+# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
+# 
+# T2 SDE: package/.../dhcp/dhcp-bind.patch.cross
+# Copyright (C) 2010 The T2 SDE Project
+# 
+# More information can be found in the files COPYING and README.
+# 
+# This patch file is dual-licensed. It is available under the license the
+# patched project is licensed under, as long as it is an OpenSource license
+# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
+# of the GNU General Public License as published by the Free Software
+# Foundation; either version 2 of the License, or (at your option) any later
+# version.
+# --- T2-COPYRIGHT-NOTE-END ---
+
+diff -ruN dhcp-4.2.0/bind/bind-9.8.0/lib/export/dns/Makefile.in dhcp-4.2.0_new/bind/bind-9.8.0/lib/export/dns/Makefile.in
+--- dhcp-4.2.0/bind/bind-9.8.0/lib/export/dns/Makefile.in	2009-12-06 02:31:40.000000000 +0300
++++ dhcp-4.2.0_new/bind/bind-9.8.0/lib/export/dns/Makefile.in	2010-08-17 13:04:52.622313241 +0400
+@@ -160,7 +160,7 @@
+ 	./gen -s ${srcdir} > code.h
+ 
+ gen: ${srcdir}/gen.c
+-	${CC} ${ALL_CFLAGS} ${LDFLAGS} -o $@ ${srcdir}/gen.c ${LIBS}
++	${BUILD_CC} ${ALL_CFLAGS} ${BUILD_LDFLAGS} -o $@ ${srcdir}/gen.c ${BUILD_LIBS}
+ 
+ #We don't need rbtdb64 for this library
+ #rbtdb64.@O@: rbtdb.c
diff --git a/configure b/configure
index 7eb64ef..511176b 100755
--- a/configure
+++ b/configure
@@ -9888,4 +9888,4 @@ if test "$no_create" != yes; then
 fi
 
 
-sh util/bindvar.sh
+sh util/bindvar.sh $host_alias $build_alias
diff --git a/util/bindvar.sh b/util/bindvar.sh
index 71170c4..8ab6bee 100644
--- a/util/bindvar.sh
+++ b/util/bindvar.sh
@@ -32,4 +32,6 @@ done
 cat <<EOF > bind/bindvar.tmp
 binddir=$binddir/bind
 GMAKE=$gmake
+host_alias=$1
+build_alias=$2
 EOF
-- 
1.7.0.4

